# Secrets 管理計画

## 目的

`~/.secrets` などの機密情報を暗号化して dotfiles リポジトリに含め、1Password CLI と統合して安全に管理する。

## 現状

- `~/.secrets` は git 管理外
- 手動で各マシンに設定が必要
- バックアップがない

## 方針

**1Password CLI + テンプレート方式**を採用

### 理由
- SOPS + age は鍵管理が別途必要
- 1Password CLI なら既存の 1Password で完結
- `op inject` でテンプレートから直接生成できる
- マシン間で同期不要（1Password が同期）

## 実装計画

### Phase 1: 基本構成

1. **テンプレートファイルを作成**

   ```
   secrets/
   ├── secrets.tpl      # ~/.secrets 用テンプレート
   └── README.md        # 使い方
   ```

2. **secrets.tpl の例**

   ```bash
   # Generated by: op inject -i secrets.tpl -o ~/.secrets
   # DO NOT EDIT MANUALLY

   export ANTHROPIC_API_KEY="{{ op://Personal/Anthropic API/credential }}"
   export OPENAI_API_KEY="{{ op://Personal/OpenAI API/credential }}"
   export GITHUB_TOKEN="{{ op://dotfiles/GitHub Token/token }}"
   ```

3. **生成コマンド**

   ```bash
   op inject -i ~/ghq/github.com/P4sTela/dotfiles/secrets/secrets.tpl -o ~/.secrets
   ```

### Phase 2: Home Manager 統合

1. **activation script で自動生成**

   ```nix
   # home/common.nix または darwin.nix
   home.activation.generateSecrets = lib.hm.dag.entryAfter ["writeBoundary"] ''
     if command -v op &> /dev/null && op account list &> /dev/null; then
       $DRY_RUN_CMD op inject -i ${./secrets/secrets.tpl} -o ~/.secrets
     fi
   '';
   ```

2. **注意点**
   - 1Password にサインインしていない場合はスキップ
   - CI/CD 環境では実行しない

### Phase 3: 追加の secrets 対応

必要に応じて追加：

- `~/.config/gh/hosts.yml` - GitHub CLI 認証
- `~/.npmrc` - npm トークン
- SSH 秘密鍵（1Password SSH Agent で代替可能）

## 必要な準備

1. **1Password CLI インストール**
   ```bash
   brew install 1password-cli
   ```

2. **1Password アプリとの連携を有効化**
   - 1Password > Settings > Developer > CLI integration

3. **Vault 構成**
   - `Personal` - 個人 API キー
   - `dotfiles` - dotfiles 用シークレット（共有可能）

## セキュリティ考慮事項

- テンプレートファイル自体には秘密情報を含めない
- `~/.secrets` は `600` パーミッションで生成
- `.gitignore` に `~/.secrets` を追加済み（fish で source）

## 代替案（不採用）

### SOPS + age

```bash
# 暗号化
sops -e secrets.yaml > secrets.enc.yaml

# 復号
sops -d secrets.enc.yaml > ~/.secrets
```

**不採用理由**: age 秘密鍵の管理が別途必要。1Password に保存できるが二重管理になる。

### sops-nix

**不採用理由**: NixOS/nix-darwin 向けで、standalone Home Manager では設定が複雑。

## 参考リンク

- [1Password CLI - Secret References](https://developer.1password.com/docs/cli/secret-references/)
- [op inject](https://developer.1password.com/docs/cli/reference/commands/inject)
